!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.ZegoClient=t()}(this,function(){"use strict";function e(e,t){this._id="number"==typeof e?e:null,this._data=t||null,this.next=null,this.prev=null}function t(){this.start=new e,this.end=new e,this.start.next=this.end,this.start.prev=null,this.end.prev=this.start,this.end.next=null,this._idCounter=0,this._numNodes=0}function r(){this.logSeq=0,this.logLevel=D.disable,this.logRemoteLevel=D.disable,this.websocket=null,this.url="",this.appid=0,this.sessionid="0",this.roomid="",this.userid="",this.userName="",this.logCache=[],this.logCacheSend=[],this.logCacheMax=100}function s(e,t,r){var s=new Date,i=1900+s.getYear()+"/";i+=(U[s.getMonth()+1]||s.getMonth()+1)+"/",i+=(U[s.getDate()]||s.getDate())+" ",i+=(U[s.getHours()]||s.getHours())+":",i+=(U[s.getMinutes()]||s.getMinutes())+":",i+=U[s.getSeconds()]||s.getSeconds(),i+="."+s.getTime()%1e3;var o=r.substr(0,r.indexOf(" "));0==o.length&&(o=r);var a=r.substr(r.indexOf(" ")+1);0==a.length&&(a="");var n={time:i,level:t,action:o,content:a,appid:e.appid,roomid:e.roomid,userid:e.userid,userName:e.userName,sessionid:e.sessionid};return[JSON.stringify(n)]}function i(e,t,r,s,i,o,a,n){this.streamid=t,this.viewMode=o,this.urls=r,this.playUrlIndex=0,this.playUrlTryCount=0,this.view=s,this.reconnectLimit=i,this.reconnectCount=0,this.state=A.stop,this.playerStat={videoBytes:0,videoFrameCnt:0,videoDecodeFrameCnt:0},this.player=null,this.stateTimeStamp=0,this.logger=e,this.firstCallback=!0,this.decode=!0,this.workerUrl=a,this.workerPlayerJSBlob=n}function o(e){this.sourceType=N.cdn,this.playerList={},this.playerCount=0,this.playerMonitorTimer=null,this.playerMonitorInterval=1e3,this.playerStartTimeout=5e3,this.playerStartBitrate=12500,this.playerStopBitrate=1250,this.playerStopTimeout=5e3,this.logger=e,this.playerInfo={}}function a(e,t){for(;t.playUrlTryCount<t.urls.length;)if(++t.reconnectCount>t.reconnectLimit)t.playUrlTryCount++,t.playUrlIndex=(t.playUrlIndex+1)%t.urls.length,t.reconnectCount=0;else if(e.logger.info("tsp.0 streamid: "+t.streamid+", index:"+t.playUrlIndex+", url:"+t.getCurrentPlayerUrl()),t.newPlayer(e,e.sourceType))break;return t.playUrlTryCount>=t.urls.length&&(e.logger.info("tsp.1 stream: ",t.streamid),t.resetPlayer(),P.DestroySingleRenderer(t.view.id),delete e.playerList[t.streamid],--e.playerCount,e.onPlayStateUpdate(I.error,t.streamid)),n(e),!0}function n(e){e.playerCount>0?e.playerMonitorTimer||(e.logger.debug("upm.1 called"),e.playerMonitorTimer=setInterval(function(){!function(e){var t,r,s,i,o=Date.now(),u=0;for(var h in e.playerList)if(t=e.playerList[h]){if(r=t.player.playoutStatus.videoBytes-t.playerStat.videoBytes,s=t.player.playoutStatus.videoFrameCnt-t.playerStat.videoFrameCnt,i=t.player.playoutStatus.videoDecodeFrameCnt-t.playerStat.videoDecodeFrameCnt,u=o-t.stateTimeStamp,t.state===B.start)if(r>=u/1e3*e.playerStartBitrate&&i>0){t.state=B.playing,t.stateTimeStamp=o,t.playUrlTryCount=0,t.updatePlayerStat(),e.logger.info("ups.1 streamid: ",t.streamid),t.firstCallback&&(t.firstCallback=!1,e.onPlayStateUpdate(I.start,t.streamid));var d=e.playerInfo[h];void 0!==d?t.enableDecode(d):(e.logger.info("ups.1 don't set decode: "+t.streamid),d=!0),d&&l(e,t,r,s,i,u)}else u>=e.playerStartTimeout&&(e.logger.info("ups.2 streamid: "+t.streamid),a(e,t));else t.state===B.playing&&u>=e.playerStopTimeout&&t.decode&&(r<u/1e3*e.playerStopBitrate?(t.state=B.stop,t.stateTimeStamp=o,e.logger.info("ups.3 streamid: "+t.streamid),a(e,t)):(t.stateTimeStamp=o,t.updatePlayerStat(),t.decode&&l(e,t,r,s,i,u)));e.logger.debug("ups.0 streamid: "+h+": videoBytesAdd="+r+"videoFrameCntAdd="+s+"videoDecodeFrameCntAdd="+i)}else delete e.playerList[h];n(e)}(e)},e.playerMonitorInterval)):e.playerMonitorTimer&&(e.logger.debug("upm.2 called"),clearInterval(e.playerMonitorTimer),e.playerMonitorTimer=null)}function l(e,t,r,s,i,o){var a=i/(o/1e3),n=8*r/o,l={fps:a,kbs:n};e.onPlayQualityUpdate(t.streamid,l),e.logger.info("oups.1 streamid:"+t.streamid+"fps="+a+" kbs="+n)}function u(){this.appid=0,this.server="",this.idName="",this.nickName="",this.configOK=!1,this.logger=new r,this.userStateUpdate=!1,this.userSeq=0,this.userQuerying=!1,this.userTempList=[],this.roomid="",this.token="",this.role=0,this.callbackList={},this.runState=M.logout,this.lastRunState=M.logout,this.userid="",this.sessionid="",this.cmdSeq=0,this.websocket=null,this.globalHeader=null,this.tryLoginCount=0,this.tryLoginTimer=null,this.tryHeartbeatCount=0,this.tryHeartbeatTimer=null,this.heartbeatInterval=3e4,this.streamList=[],this.streamQuerying=!1,this.mapStreamDom={},this.mapStreamQuality={},this.mapViewMode={},this.preferPlaySourceType=F.cdn,this.wsPlayerList={},this.playerCenter=new o(this.logger),this.playerCenter.onPlayStateUpdate=this.onPlayStateUpdateHandle.bind(this),this.playerCenter.onPlayQualityUpdate=this.onPlayQualityUpdateHandle.bind(this),this.playerStateTimer=null,this.playerStateInterval=2e3,this.sendDataMap={},this.sendDataList=new t,this.sendDataCheckTimer=null,this.sendDataCheckInterval=2e3,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.sendDataCheckOnceCount=100,this.sendRoomMsgTime=0,this.SendRoomMsgInterval=500}function h(e,t,r,s){e.logger.debug("zc.p.dps.0 call");for(var i=null,o=0;o<e.streamList.length;o++)if(e.streamList[o].stream_id===t){i=e.streamList[o].urls_ws||[];break}return!(!i||i.length<=0)&&(e.logger.info("zc.p.dps.0 streamid: "+t+" streamUrl: "+i),e.playerCenter.startPlayingStream(t,i,r,s,e.workerUrl,e.workerPlayerJSBlob),e.logger.debug("zc.p.dps.0 call success"),!0)}function d(e,t){return e.callbackList[t+"ErrorCallback"]}function c(e){var t={1:"parse json error.",1001:"login is processing.",1002:"liveroom request error.",1003:"zpush connect fail.",1004:"zpush handshake fail.",1005:"zpush login fail.",1006:"user login state is wrong.",1007:"got no zpush addr",1008:"token error",1009:"dispatch error",1e9:"liveroom cmd error, result="};if(0===e)return{code:"ZegoClient.Success",msg:"success"};var r={};return r.code="ZegoClient.Error.Server",r.msg=e>1e9?t[1e9]+e:void 0!=t[e]?t[e]:"unknown error code:"+e,r}function g(e,t){e.logger.debug("srs.0 old="+e.runState+", new="+t),e.lastRunState=e.runState,e.runState=t}function p(e,t){return e.globalHeader={Protocol:"req",cmd:t,appid:e.appid,seq:++e.cmdSeq,user_id:e.userid,session_id:e.sessionid,room_id:e.roomid},e.globalHeader}function f(e,t,r){if(e.logger.debug("sm.0 call "+t),e.websocket&&1===e.websocket.readyState){var s={header:p(e,t),body:r},i=JSON.stringify(s);e.websocket.send(i),e.logger.debug("sm.0 success")}else e.logger.info("sm.0 error")}function m(e,t,r,s,i){if(e.logger.debug("scm.0 call"),!e.websocket||1!==e.websocket.readyState)return e.logger.info("scm.0 error"),!1;var o=p(e,t),a={header:o,body:r},n=JSON.stringify(a);void 0==s&&(s=null),void 0==i&&(i=null);var l={data:a,seq:o.seq,deleted:!1,time:Date.parse(new Date),success:s,error:i},u=e.sendDataList.push(l);return e.sendDataMap[l.seq]=u,e.websocket.send(n),e.logger.debug("scm.0 success seq: ",o.seq),!0}function y(e){if(e.logger.debug("scmt.0 call"),e.runState===M.login){for(var t=e.sendDataList.getFirst(),r=Date.parse(new Date),s=0,i=0,o=0;!(null==t||t._data.time+e.sendDataTimeout>r||(delete e.sendDataMap[t._data.data.header.seq],e.sendDataList.remove(t),++i,null==t._data.error||e.sendDataDropTimeout>0&&t._data.time+e.sendDataDropTimeout>r?++o:t._data.error(W.SEND_MSG_TIMEOUT,t._data.data.header.seq,t._data.data.body.custom_msg),++s>=e.sendDataCheckOnceCount));)t=e.sendDataList.getFirst();e.sendDataCheckTimer=setTimeout(function(){y(e)},e.sendDataCheckInterval),e.logger.debug("scmt.0 call success, stat: timeout=",i,"drop=",o)}else e.logger.info("scmt.0 state error")}function b(e){e.logger.debug("rcm.0 call"),clearTimeout(e.sendDataCheckTimer),e.sendDataCheckTimer=null;for(var t=e.sendDataList.getFirst();null!=t;)e.sendDataList.remove(t),null!=t._data.error&&t._data.error(W.RESET_QUEUE,t._data.data.header.seq,t._data.data.body.custom_msg),t=e.sendDataList.getFirst();e.sendDataMap={},e.logger.debug("rcm.0 call success")}function v(e){e.logger.debug("rht.0 call"),clearTimeout(e.heartbeatTimer),e.heartbeatTimer=null,e.tryHeartbeatCount=0,e.logger.debug("rht.0 call success")}function _(e){if(e.logger.debug("sht.0 call"),e.runState===M.login){if(++e.tryHeartbeatCount>H)return e.logger.error("sht.0 come to try limit"),g(e,M.logout),k(e),void e.onDisconnect(W.HEARTBEAT_TIMEOUT);e.logger.debug("sht.0 send packet");f(e,"hb",{reserve:0}),e.heartbeatTimer=setTimeout(function(){_(e)},e.heartbeatInterval),e.logger.debug("sht.0 call success")}else e.logger.info("sht.0 state error")}function w(e){e.logger.debug("rtl.0 call"),clearTimeout(e.tryLoginTimer),e.tryLoginTimer=null,e.tryLoginCount=0,e.logger.debug("rtl.0 call success")}function T(e){if(e.logger.debug("tl.0 call"),e.runState===M.trylogin){if(++e.tryLoginCount>z){e.logger.error("tl.0 fail times limit");var t=e.lastRunState;return g(e,M.logout),k(e),void(t==M.login?(e.logger.info("tl.0 fail and disconnect"),e.onDisconnect(W.LOGIN_DISCONNECT)):(e.logger.info("tl.0 fail and callback user"),d(e,"login")(W.LOGIN_TIMEOUT)))}if(e.websocket&&1===e.websocket.readyState){e.logger.info("tl.0 use current websocket and sent login");var r=S(e);f(e,"login",r)}else{e.logger.debug("tl.0 need new websocket");try{e.websocket&&(e.logger.info("tl.0 close error websocket"),e.websocket.onclose=null,e.websocket.onerror=null,e.websocket.close(),e.websocket=null),e.logger.debug("tl.0 new websocket"),e.websocket=new WebSocket(e.server),e.websocket.onopen=function(){e.logger.info("tl.0 websocket.onpen call"),function(e){e.websocket.onmessage=function(t){var r=JSON.parse(t.data);if(e.logger.debug("jsonmsg=",JSON.parse(t.data)),"login"!==r.header.cmd)if(r.header.appid===e.appid&&r.header.session_id===e.sessionid&&r.header.user_id===e.userid&&r.header.room_id===e.roomid&&e.runState===M.login)switch(r.header.cmd){case"hb":!function(e,t){if(e.logger.debug("hhbr.0 call stream_seq "+t.body.stream_seq+" user_seq "+t.body.server_user_seq),0!==t.body.err_code){e.logger.info("hhbr.0 call disconnect, server error=",t.body.err_code),g(e,M.logout),k(e);var r=c(t.body.err_code);return void e.onDisconnect(r)}e.tryHeartbeatCount=0,e.heartbeatInterval=t.body.hearbeat_interval,e.heartbeatInterval<Y&&(e.heartbeatInterval=Y);t.body.stream_seq!==e.streamSeq&&(e.logger.info("hhbr.0 call update stream"),C(e));t.body.server_user_seq!==e.userSeq&&e.userStateUpdate&&(e.logger.info("hhbr.0 call update user "+t.body.server_user_seq,e.userSeq),x(e));e.logger.debug("hhbr.0 call success")}(e,r);break;case"logout":!function(e,t){e.logger.debug("hlor.0 result=",t.body.err_code)}(e,r);break;case"custommsg":!function(e,t){e.logger.debug("hscmr.0 call");var r,s=e.sendDataMap[t.header.seq];null!=s?("custommsg"!=(r=s._data).data.header.cmd?e.logger.error("hscmr.0 cmd wrong"+r.data.header.cmd):0===t.body.err_code?null!=r.success&&r.success(t.header.seq,r.data.body.custom_msg):null!=r.error&&r.error(c(t.body.err_code),t.header.seq,r.data.body.custom_msg),delete e.sendDataMap[t.header.seq],e.sendDataList.remove(s)):e.logger.error("hscmr.0 no found seq="+t.header.seq);e.logger.debug("hscmr.0 call success")}(e,r);break;case"stream_info":!function(e,t){if(e.logger.debug("hfslr.0 call"),e.streamQuerying=!1,0!==t.body.err_code)return void e.logger.info("hfslr.0 server error=",t.body.err_code);if(e.streamSeq===t.body.stream_seq)return void e.logger.info("hfslr.0 same seq");L(e,t.body.stream_seq,t.body.stream_info),e.logger.debug("hfslr.0 call success")}(e,r);break;case"push_custommsg":!function(e,t){var r=JSON.parse(t.body.custommsg);e.logger.debug("hpcm.0 submsg=",r),e.onRecvCustomCommand(r.from_userid,r.from_username,r.custom_content)}(e,r);break;case"push_stream_update":!function(e,t){if(e.logger.debug("hpsum.0 call"),!t.body.stream_info||0===t.body.stream_info.length)return void e.logger.info("hpsum.0, emtpy list");if(t.body.stream_info.length+e.streamSeq!==t.body.stream_seq)return e.logger.info("hpsum.0 call updatestream"),void C(e);switch(e.streamSeq=t.body.stream_seq,t.body.stream_cmd){case O.added:!function(e,t){e.logger.debug("hasl.0 call");for(var r,s=[],i=0;i<t.length;i++){r=!1;for(var o=0;o<e.streamList.length;o++)if(t[i].stream_id===e.streamList[o].stream_id){r=!0;break}r||s.push(t[i])}0!==s.length&&(e.logger.debug("hasl.0 callback addstream"),e.streamList.concat(s),e.onStreamUpdated(q.added,E(s)));e.logger.debug("hasl.0 call success")}(e,t.body.stream_info);break;case O.deleted:!function(e,t){e.logger.debug("hdsl.0 call");for(var r=[],s=0;s<t.length;s++)for(var i=e.streamList.length-1;i>=0;i--)if(t[s].stream_id===e.streamList[i].stream_id){e.streamList.splice(i,1),r.push(t[s]);break}0!==r.length&&(e.logger.debug("hdsl.0 callback delstream"),e.onStreamUpdated(q.deleted,E(r)));e.logger.debug("hdsl.0 call")}(e,t.body.stream_info);break;case O.updated:!function(e,t){e.logger.debug("husl.0 call");for(var r=[],s=0;s<t.length;s++)for(var i=0;i<e.streamList.length;i++)if(t[s].stream_id===e.streamList[i].stream_id){t[s].extra_info!==e.streamList[i].extra_info&&(e.streamList[i]=t[s],r.push(t[s]));break}0!==r.length&&(e.logger.debug("husl.0 callback updatestream"),e.onStreamExtraInfoUpdated(E(r)));e.logger.debug("husl.0 call success")}(e,t.body.stream_info)}e.logger.debug("hpsum.0 call success")}(e,r);break;case"push_kickout":!function(e,t){e.logger.info("hpk.0 call"),g(e,M.logout),k(e);var r={code:W.KICK_OUT.code,msg:W.KICK_OUT.msg+t.body.reason};e.onKickOut(r),e.logger.debug("hpk.0 call success")}(e,r);break;case"stream_url":!function(e,t){if(e.logger.debug("hfsur.0 call"),e.streamQuerying=!1,0!==t.body.err_code)return void e.logger.info("hfsur.0 server error=",t.body.err_code);if(t.body.stream_url_infos&&t.body.stream_url_infos.length>0){var r=t.body.stream_url_infos[0].stream_id,s=t.body.stream_url_infos[0].urls_ws;if(e.streamList.length>0)for(var i=0;i<e.streamList.length;i++){var o=e.mapStreamQuality[r];if(e.streamList[i].stream_id===r){e.streamList[i].urls_ws=s,e.streamList[i].quality=o;break}e.streamList.push({stream_id:r,urls_ws:s,quality:o}),o&&(e.logger.debug("hfsur.0 remove quality"),delete e.mapStreamQuality[r])}else e.streamList.push({stream_id:r,urls_ws:s});var a=e.mapStreamDom[r],n=e.mapViewMode[r];a&&(e.logger.debug("hfsur.0 play"),delete e.mapStreamDom[r],h(e,r,a,n))}}(e,r);break;case"im_chat":!function(e,t){e.logger.debug("hsrmr.0 call");var r,s=e.sendDataMap[t.header.seq];null!=s?("im_chat"!=(r=s._data).data.header.cmd?e.logger.error("hsrmr.0 cmd wrong"+r.data.header.cmd):0===t.body.err_code?r.success&&r.success(t.header.seq,t.body.msg_id,r.data.body.msg_category,r.data.body.msg_type,r.data.body.msg_content):r.error&&r.error(c(t.body.err_code),t.header.seq,r.data.body.msg_category,r.data.body.msg_type,r.data.body.msg_content),delete e.sendDataMap[t.header.seq],e.sendDataList.remove(s)):e.logger.error("hsrmr.0 no found seq="+t.header.seq);e.logger.debug("hsrmr.0 call success")}(e,r);break;case"push_im_chat":!function(e,t){e.onRecvRoomMsg(t.body.chat_data,t.body.server_msg_id,t.body.ret_msg_id)}(e,r);break;case"push_userlist_update":!function(e,t){if(e.logger.debug("hpus.0 call server user seq "+t.body.user_list_seq+" userSeq "+e.userSeq),e.runState!=M.login)return void e.logger.info("hpus.0 not login");if(!e.userStateUpdate)return void e.logger.info("hpus.0 no userStateUpdate flag");if(e.userSeq+t.body.user_actions.length!==t.body.user_list_seq)return e.logger.info("hpus.0 fetch new userlist "+e.userSeq,NaN+t.body.user_list_seq),void x(e);e.userSeq=t.body.user_list_seq,e.logger.debug("hpus.0 push userSeq "+e.userSeq);for(var r=[],s=0;s<t.body.user_actions.length;s++){var i={action:t.body.user_actions[s].Action,idName:t.body.user_actions[s].IdName,nickName:t.body.user_actions[s].NickName,role:t.body.user_actions[s].Role,loginTime:t.body.user_actions[s].LoginTime};r.push(i)}e.onUserStateUpdate(t.body.room_id,r),e.logger.debug("hpus.0 call success")}(e,r);break;case"user_list":!function(e,t){if(e.logger.debug("hfulr.0 call"),0!=t.body.err_code)return e.userQuerying=!1,void e.logger.info("hfulr.0 fetch error "+t.body.err_code);if(!e.userStateUpdate)return;e.userTempList.push.apply(e.userTempList,t.body.user_baseinfos);var r=t.body.ret_user_index,s=t.body.server_user_index;if(r!=s)return e.logger.info("hfulr.0 fetch another page"),void R(r+1);e.userSeq=t.body.server_user_seq,e.logger.info("hfulr.0 set user Seq "+e.userSeq);for(var i=[],o=0;o<e.userTempList.length;o++){var a={idName:e.userTempList[o].id_name,nickName:e.userTempList[o].nick_name,role:e.userTempList[o].role};i.push(a)}e.userQuerying=!1,e.onGetTotalUserList(e.roomid,i),e.userTempList=[],e.logger.debug("hfulr.0 call success user_list "+i+" count "+i.length)}(e,r)}else e.logger.info("ws.bwsh.0 check session fail.");else!function(e,t){if(e.logger.debug("hlr.0 call"),e.runState!==M.trylogin)return void e.logger.info("hlr.0 state error");if(t.header.seq!==e.cmdSeq)return void e.logger.info("hlr.0 in wrong seq, local=",e.cmdSeq,",recv=",t.header.seq);if(0!==t.body.err_code)return function(e,t){if(e.logger.debug("hlf.0 call"),function(e){switch(t.body.err_code){case 1002:case 1003:return!0;default:return!1}}())return void e.logger.info("hlf.0 KeepTry true");var r=e.lastRunState;g(e,M.logout),k(e);var s=c(t.body.err_code);r==M.login?(e.logger.info("hlf.0 callback disconnect"),e.onDisconnect(s)):(e.logger.info("hlf.0 callback error"),d(e,"login")(s));e.logger.debug("hlf.0 call success")}(e,t),void e.logger.info("hlr.0 server error=",t.body.err_code);(function(e,t){e.logger.debug("hls.0 call");var r=e.lastRunState;g(e,M.login),e.userid=t.body.user_id,e.sessionid=t.body.session_id,e.logger.setSessionInfo(e.appid,e.roomid,e.userid,e.idName,e.sessionid),void 0!=t.body.config_info&&(e.logger.setRemoteLogLevel(t.body.config_info.log_level),""!=t.body.config_info.log_url&&e.logger.openLogServer(t.body.config_info.log_url));w(e),v(e),e.heartbeatInterval=t.body.hearbeat_interval,e.heartbeatInterval<Y&&(e.heartbeatInterval=Y);if(e.heartbeatTimer=setTimeout(function(){_(e)},e.heartbeatInterval),b(e),e.sendDataCheckTimer=setTimeout(function(){y(e)},e.sendDataCheckInterval),e.streamQuerying=!1,r==M.login)e.logger.info("hls.0 recover from disconnect so call streamupdate"),L(e,t.body.stream_seq,t.body.stream_info||[]);else{e.logger.info("hls.0 success callback user"),e.streamList=t.body.stream_info||[],e.streamSeq=t.body.stream_seq;var s=[];s=E(e.streamList),function(e,t){return e.callbackList[t+"SuccessCallback"]}(e,"login")(s)}e.logger.debug("hls.0 userStateUpdate "+e.userStateUpdate),e.userStateUpdate&&(e.logger.info("hls.0 fetch all new userlist"),x(e));e.logger.debug("hls.0 call success")})(e,t),e.logger.info("hlr.0 call success.")}(e,r)},e.websocket.onclose=function(t){e.logger.info("ws.oc.0 msg="+JSON.stringify(t)),e.runState!==M.logout?e.runState===M.trylogin&&e.tryLoginCount<=z?e.logger.info("ws.oc.0 is called because of try login"):e.runState===M.login?(e.logger.info("ws.oc.0 is called because of network broken, try again"),g(e,M.trylogin),w(e),T(e)):(e.logger.info("ws.oc.0 out of think!!!"),g(e,M.logout),k(e),e.onDisconnect(W.UNKNOWN)):e.logger.info("ws.oc.0 onclose logout flow call websocket.close")},e.websocket.onerror=function(t){e.logger.info("ws.oe.0 msg="+JSON.stringify(t))}}(e),e.logger.info("tl.0 websocket.onpen send login");var t=S(e);f(e,"login",t),e.logger.debug("tl.0 websocket.onpen call success")}}catch(t){e.logger.error("tl.0 websocket err:"+t)}}e.tryLoginTimer=setTimeout(function(){T(e)},G[e.tryLoginCount%z]),e.logger.debug("tl.0 call success")}else e.logger.info("tl.0 state error")}function S(e){return{id_name:e.idName,nick_name:e.nickName,role:e.role,token:e.token,version:V,user_state_flag:e.userStateUpdate?1:0}}function k(e){if(e.logger.debug("rr.0 call"),w(e),v(e),b(e),e.streamList=[],e.streamQuerying=!1,e.mapStreamDom={},e.mapStreamQuality={},e.preferPlaySourceType=F.cdn,e.logger.debug("rr.0 call send logout=",e.sessionid),"0"!==e.sessionid){f(e,"logout",{reserve:0})}e.websocket&&(e.websocket.onclose=null,e.websocket.onerror=null,e.websocket.close(),e.websocket=null),e.userid="0",e.sessionid="0",e.logger.setSessionInfo(e.appid,e.roomid,e.userid,e.idName,e.sessionid),e.logger.debug("rr.0 call success")}function C(e){if(e.logger.debug("fsl.0 call"),e.runState===M.login)if(e.streamQuerying)e.logger.info("fsl.0 already doing");else{e.streamQuerying=!0,e.logger.debug("fsl.0 send fetch request");f(e,"stream_info",{reserve:0}),e.logger.debug("fsl.0 call success")}else e.logger.info("fsl.0 state error")}function x(e){e.logger.debug("ful.0 call"),e.userQuerying?e.logger.info("ful.0 is already querying"):(e.userQuerying=!0,e.userTempList=[],R(e,0),e.logger.debug("ful.0 the first time call"))}function R(e,t){e.logger.debug("fulwp.0 call");f(e,"user_list",{user_index:t,sort_type:0}),e.logger.debug("fulwp.0 call success")}function L(e,t,r){e.logger.debug("hfus.0 call"),e.streamSeq=t,function(e,t,r,s){e.logger.debug("msl.0 call");for(var i,o=[],a=[],n=[],l=0;l<r.length;l++){i=!1;for(var u=0;u<t.length;u++)if(r[l].stream_id===t[u].stream_id){r[l].extra_info!==t[u].extra_info&&n.push(r[l]),i=!0;break}i||o.push(r[l])}for(var h=0;h<t.length;h++){i=!1;for(var d=0;d<r.length;d++)if(t[h].stream_id===r[d].stream_id){i=!0;break}i||a.push(t[h])}t=r,s(o,a,n),e.logger.debug("msl.0 call success")}(e,e.streamList,r,function(t,r,s){0!==t.length&&(e.logger.debug("hfus.0 callback addstream"),e.onStreamUpdated(q.added,E(t))),0!==r.length&&(e.logger.debug("hfus.0 callback delstream"),e.onStreamUpdated(q.deleted,E(r))),0!==s.length&&(e.logger.debug("hfus.0 callback updatestream"),e.onStreamExtraInfoUpdated(E(s)))}),e.logger.debug("hfus.0 call success")}function E(e){var t=[];if(void 0!=e&&null!=e)for(var r=0;r<e.length;r++)t.push({anchor_id_name:e[r].anchor_id_name,stream_gid:e[r].stream_gid,anchor_nick_name:e[r].anchor_nick_name,extra_info:e[r].extra_info,stream_id:e[r].stream_id});return t}e.prototype={id:function(e){if(null===e||void 0===e)return this._id;if("number"!=typeof e)throw new Error("Id must be an integer.");this._id=e},data:function(e){if(null===e||void 0===e)return this._data;this._data=e},hasNext:function(){return null!==this.next&&null!==this.next.id()},hasPrev:function(){return null!==this.prev&&null!==this.prev.id()}},t.prototype={insertBefore:function(t,r){var s=new e(this._idCounter,r);return s.next=t,s.prev=t.prev,t.prev.next=s,t.prev=s,++this._idCounter,++this._numNodes,s},addLast:function(e){return this.insertBefore(this.end,e)},add:function(e){return this.addLast(e)},getFirst:function(){return 0===this._numNodes?null:this.start.next},getLast:function(){return 0===this._numNodes?null:this.end.prev},size:function(){return this._numNodes},getFromFirst:function(e){var t=0,r=this.start.next;if(e>=0)for(;t<e&&null!==r;)r=r.next,++t;else r=null;if(null===r)throw"Index out of bounds.";return r},get:function(e){return 0===e?this.getFirst():e===this._numNodes-1?this.getLast():this.getFromFirst(e)},remove:function(e){return e.prev.next=e.next,e.next.prev=e.prev,--this._numNodes,e},removeFirst:function(){var e=null;return this._numNodes>0&&(e=this.remove(this.start.next)),e},removeLast:function(){var e=null;return this._numNodes>0&&(e=this.remove(this.end.prev)),e},removeAll:function(){this.start.next=this.end,this.end.prev=this.start,this._numNodes=0,this._idCounter=0},each:function(e){for(var t=this.start;t.hasNext();)e(t=t.next)},find:function(e){for(var t=this.start,r=!1,s=null;t.hasNext()&&!r;)e(t=t.next)&&(s=t,r=!0);return s},map:function(e){for(var t=this.start,r=[];t.hasNext();)e(t=t.next)&&r.push(t);return r},push:function(e){return this.addLast(e)},unshift:function(e){this._numNodes>0?this.insertBefore(this.start.next,e):this.insertBefore(this.end,e)},pop:function(){return this.removeLast()},shift:function(){return this.removeFirst()}};var D={debug:0,info:1,warn:2,error:3,report:99,disable:100};r.prototype.setLogLevel=function(e){this.logLevel=e,(this.logLevel<D.debug||this.logLevel>D.report)&&(this.logLevel=D.disable)},r.prototype.setRemoteLogLevel=function(e){this.logRemoteLevel=e,(this.logRemoteLevel<D.debug||this.logRemoteLevel>D.report)&&(this.logRemoteLevel=D.disable)},r.prototype.setSessionInfo=function(e,t,r,s,i){this.appid=e,this.roomid=t,this.sessionid=r,this.userid=s,this.userName=i},r.prototype.openLogServer=function(e){if(this.url!=e){if(this.url=e,this.stopLogServer(),!e)return;this.websocket=new WebSocket(e),this.websocket.onopen=function(e){},this.websocket.onclose=function(e){},this.websocket.onmessage=function(e){},this.websocket.onerror=function(e){console.log("ws发生错误！")}}},r.prototype.stopLogServer=function(){this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},r.prototype.RemoteLog=function(e,t){if(""!=this.url)if(null==this.websocket||2==this.websocket.readyState||3==this.websocket.readyState){var r=this.url;this.url="",this.openLogServer(r),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t)}else if(0==this.websocket.readyState)this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t);else if(1==this.websocket.readyState){if(this.logCacheSend>0){for(var s="",i=0;i<this.logCacheSend.length;i++)s=s+this.logCacheSend[i]+"\n";t=s+t,this.logCacheSend=[]}this.websocket.send(t)}else this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t)},r.prototype.log=function(e,t){if(this.logLevel!==D.disable&&this.logLevel<=e)for(this.logCache.push(t);this.logCache.length>this.logCacheMax;)this.logCache.shift();this.logRemoteLevel!==D.disable&&this.logRemoteLevel<=e&&this.RemoteLog(e,t)},r.prototype.debug=function(){var e=s(this,"debug","".concat([].slice.call(arguments)));this.logLevel!==D.disable&&this.logLevel<=D.debug&&console.debug.apply(console,e),this.log(D.debug,e)},r.prototype.info=function(){var e=s(this,"info","".concat([].slice.call(arguments)));this.logLevel!==D.disable&&this.logLevel<=D.info&&console.info.apply(console,e),this.log(D.info,e)},r.prototype.warn=function(){var e=s(this,"warn","".concat([].slice.call(arguments)));this.logLevel!==D.disable&&this.logLevel<=D.warn&&console.warn.apply(console,e),this.log(D.warn,e)},r.prototype.error=function(){var e=s(this,"error","".concat([].slice.call(arguments)));this.logLevel!==D.disable&&this.logLevel<=D.error&&console.error.apply(console,e),this.log(D.error,e)},r.prototype.report=function(){var e=s(this,"report","".concat([].slice.call(arguments)));this.logLevel!==D.disable&&this.logLevel<=D.report&&console.info.apply(console,e),this.log(D.report,e)};var U=["00","01","02","03","04","05","06","07","08","09"],P={Player:null,Renderer:{},AudioOutput:{},Now:function(){return window.performance?window.performance.now()/1e3:Date.now()/1e3},Fill:function(e,t){if(e.fill)e.fill(t);else for(var r=0;r<e.length;r++)e[r]=t},RendererPool:[],GetRenderer:function(e){var t=null;return this.RendererPool.forEach(function(r){r.key==e&&null!=r.value&&(t=r.value)}),t},SetRenderer:function(e,t){var r={key:e,value:t};this.RendererPool.push(r)},DestroyAllRenderer:function(){console.log("this.RendererPool = ",this.RendererPool),this.RendererPool.forEach(function(e){e&&e.value.destroy()}),this.RendererPool.splice(0,this.RendererPool.length)},DestroySingleRenderer:function(e){console.log("this.RendererPool1 = ",this.RendererPool),console.log("this.key = ",e);for(var t=this.RendererPool.length-1;t>=0;t--)this.RendererPool[t].key==e&&(this.RendererPool[t].value.destroy(),this.RendererPool.splice(t,1));console.log("this.RendererPool2 = ",this.RendererPool)}};P.VideoElement=function(){var e=function(t){var r=t.dataset.url;if(!r)throw"VideoElement has no `data-url` attribute";var s=function(e,t){for(var r in t)e.style[r]=t[r]};this.container=t,s(this.container,{display:"inline-block",position:"relative",minWidth:"80px",minHeight:"80px"}),this.canvas=document.createElement("canvas"),this.canvas.width=960,this.canvas.height=540,s(this.canvas,{display:"block",width:"100%"}),this.container.appendChild(this.canvas),this.playButton=document.createElement("div"),this.playButton.innerHTML=e.PLAY_BUTTON,s(this.playButton,{zIndex:2,position:"absolute",top:"0",bottom:"0",left:"0",right:"0",maxWidth:"75px",maxHeight:"75px",margin:"auto",opacity:"0.7",cursor:"pointer"}),this.container.appendChild(this.playButton);var i={canvas:this.canvas};for(var o in t.dataset)try{i[o]=JSON.parse(t.dataset[o])}catch(e){i[o]=t.dataset[o]}if(this.player=new P.Player(r,i),t.playerInstance=this.player,!i.poster||i.autoplay||this.player.options.streaming||(i.decodeFirstFrame=!1,this.poster=new Image,this.poster.src=i.poster,this.poster.addEventListener("load",this.posterLoaded),s(this.poster,{display:"block",zIndex:1,position:"absolute",top:0,left:0,bottom:0,right:0}),this.container.appendChild(this.poster)),this.player.options.streaming||this.container.addEventListener("click",this.onClick.bind(this)),(i.autoplay||this.player.options.streaming)&&(this.playButton.style.display="none"),this.player.audioOut&&!this.player.audioOut.unlocked){var a=this.container;(i.autoplay||this.player.options.streaming)&&(this.unmuteButton=document.createElement("div"),this.unmuteButton.innerHTML=e.UNMUTE_BUTTON,s(this.unmuteButton,{zIndex:2,position:"absolute",bottom:"10px",right:"20px",width:"75px",height:"75px",margin:"auto",opacity:"0.7",cursor:"pointer"}),this.container.appendChild(this.unmuteButton),a=this.unmuteButton),this.unlockAudioBound=this.onUnlockAudio.bind(this,a),a.addEventListener("touchstart",this.unlockAudioBound,!1),a.addEventListener("click",this.unlockAudioBound,!0)}};return e.prototype.onUnlockAudio=function(e,t){this.unmuteButton&&(t.preventDefault(),t.stopPropagation()),this.player.audioOut.unlock(function(){this.unmuteButton&&(this.unmuteButton.style.display="none"),e.removeEventListener("touchstart",this.unlockAudioBound),e.removeEventListener("click",this.unlockAudioBound)}.bind(this))},e.prototype.onClick=function(e){this.player.isPlaying?(this.player.pause(),this.playButton.style.display="block"):(this.player.play(),this.playButton.style.display="none",this.poster&&(this.poster.style.display="none"))},e.PLAY_BUTTON='<svg style="max-width: 75px; max-height: 75px;" viewBox="0 0 200 200" alt="Play video"><circle cx="100" cy="100" r="90" fill="none" stroke-width="15" stroke="#fff"/><polygon points="70, 55 70, 145 145, 100" fill="#fff"/></svg>',e.UNMUTE_BUTTON='<svg style="max-width: 75px; max-height: 75px;" viewBox="0 0 75 75"><polygon class="audio-speaker" stroke="none" fill="#fff" points="39,13 22,28 6,28 6,47 21,47 39,62 39,13"/><g stroke="#fff" stroke-width="5"><path d="M 49,50 69,26"/><path d="M 69,50 49,26"/></g></svg>',e}(),P.Player=function(){var e=function(e,t){this.options=t||{},this.autoplay=!0,t.worker?this.worker=t.worker:t.workerPlayerJSBlob?this.worker=new Worker(window.URL.createObjectURL(t.workerPlayerJSBlob)):t.workerPlayerJS?this.worker=new Worker(t.workerPlayerJS):this.worker=new Worker("jsmpeg-stub.min.js"),this.worker.onmessage=this.onMessage.bind(this),!1!==t.video&&(t.canvas&&(this.renderer=P.GetRenderer(t.canvas.id)),null==this.renderer&&(this.isSupported=P.Renderer.WebGL.IsSupported(),console.info("useWebGL:",this.isSupported),this.renderer=!t.disableGl&&this.isSupported?new P.Renderer.WebGL(t):new P.Renderer.Canvas2D(t),P.SetRenderer(t.canvas.id,this.renderer))),!1!==t.audio&&P.AudioOutput.WebAudio.IsSupported()&&(this.audioOut=new P.AudioOutput.WebAudio(t)),Object.defineProperty(this,"playoutStatus",{get:this.getPlayoutStatus}),this.unpauseOnShow=!1,!1!==t.pauseWhenHidden&&(this.showHandle=this.showHide.bind(this),document.addEventListener("visibilitychange",this.showHandle,!1)),this.worker.postMessage([0,e]),this.autoplay&&this.play(),this.videoBytes=0,this.videoFrameCnt=0,this.videoDecodeFrameCnt=0,this.videoDecodeTime=0,this.videoBreakCnt=0,this.currentY=null,this.currentCr=null,this.currentCb=null,this.isNewFrame=!1};return e.prototype.showHide=function(e){"hidden"===document.visibilityState?(this.unpauseOnShow=this.wantsToPlay,this.pause()):this.unpauseOnShow&&this.play()},e.prototype.play=function(e){this.animationId=requestAnimationFrame(this.update.bind(this)),this.wantsToPlay=!0,this.worker.postMessage([1])},e.prototype.pause=function(e){cancelAnimationFrame(this.animationId),this.wantsToPlay=!1,this.isPlaying=!1,this.worker.postMessage([2])},e.prototype.stop=function(e){this.pause()},e.prototype.destroy=function(){this.pause(),this.worker&&(this.worker.postMessage([7]),this.worker.onmessage=null,this.worker.terminate(),this.worker=null),this.renderer&&(this.renderer=null),this.audioOut&&(this.audioOut.destroy(),this.audioOut=null),this.options=null,this.showHandle&&(document.removeEventListener("visibilitychange",this.showHandle),this.showHandle=null),this.currentY=null,this.currentCr=null,this.currentCb=null},e.prototype.update=function(){this.animationId=requestAnimationFrame(this.update.bind(this)),this.isPlaying||(this.isPlaying=!0,this.startTime=P.Now()-this.currentTime),this.worker&&this.worker.postMessage([4,P.Now()]),this.isNewFrame&&(this.renderer.render(this.currentY,this.currentCb,this.currentCr),this.isNewFrame=!1)},e.prototype.getPlayoutStatus=function(){this.worker.postMessage([5]);var e={};return e.videoBytes=this.videoBytes,e.videoFrameCnt=this.videoFrameCnt,e.videoDecodeFrameCnt=this.videoDecodeFrameCnt,e.videoDecodeTime=this.videoDecodeTime,e.videoBreakCnt=this.videoBreakCnt,e.useWebGL=this.isSupported,e},e.prototype.enableDecode=function(e){this.worker.postMessage([6,e])},e.prototype.onMessage=function(e){switch(e.data[0]){case 0:this.renderer&&this.renderer.resize(e.data[1],e.data[2]);break;case 1:this.currentY=e.data[1],this.currentCb=e.data[2],this.currentCr=e.data[3],this.isNewFrame=!0;break;case 2:this.videoBytes=e.data[1],this.videoFrameCnt=e.data[2],this.videoDecodeFrameCnt=e.data[3],this.videoDecodeTime=e.data[4],this.videoBreakCnt=e.data[5]}},e}(),P.Renderer.WebGL=function(){var e=function(t){this.canvas=t.canvas,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.width=this.canvas.width,this.height=this.canvas.height,this.fixWidth=this.width,this.enabled=!0,this._error=void 0,Object.defineProperty(this,"error",{get:this.getRenderError});var r={preserveDrawingBuffer:!!t.preserveDrawingBuffer,alpha:!1,depth:!1,stencil:!1,antialias:!1};if(this.gl=this.canvas.getContext("webgl",r)||this.canvas.getContext("experimental-webgl",r),!this.gl)throw new Error("Failed to get WebGL Context");var s=this.gl;try{this.bufferConvertVertex=s.createBuffer();var i=new Float32Array([0,0,0,1,1,0,1,1]);s.bindBuffer(s.ARRAY_BUFFER,this.bufferConvertVertex),s.bufferData(s.ARRAY_BUFFER,i,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),this.convertProgram=this.createProgram(e.SHADER.VERTEX_IDENTITY,e.SHADER.FRAGMENT_YCRCB_TO_RGBA),this.attrConvertVertex=s.getAttribLocation(this.convertProgram,"vertex"),this.uniformY=s.getUniformLocation(this.convertProgram,"textureY"),this.uniformCb=s.getUniformLocation(this.convertProgram,"textureCb"),this.uniformCr=s.getUniformLocation(this.convertProgram,"textureCr"),this.textureY=this.createTexture(0,"textureY",this.convertProgram),this.textureCb=this.createTexture(1,"textureCb",this.convertProgram),this.textureCr=this.createTexture(2,"textureCr",this.convertProgram),this.loadingProgram=this.createProgram(e.SHADER.VERTEX_IDENTITY,e.SHADER.FRAGMENT_LOADING),this.bufferBlitVertex=s.createBuffer(),this.bufferBlitTexCoord=s.createBuffer(),this.blitProgram=this.createProgram(e.SHADER.VERTEX_BLIT,e.SHADER.FRAGMENT_BLIT),this.attrBlitVertex=s.getAttribLocation(this.blitProgram,"vertex"),this.attrBlitTexCoord=s.getAttribLocation(this.blitProgram,"texCoord"),this.uniformRgb=s.getUniformLocation(this.blitProgram,"textureRgb"),this.fb=s.createFramebuffer()}catch(e){this._error=e}this.shouldCreateUnclampedViews=!this.allowsClampedTextureData(),this.viewMode=t.viewMode||0};return e.prototype.destroy=function(){var e=this.gl;e.deleteTexture(this.textureY),e.deleteTexture(this.textureCb),e.deleteTexture(this.textureCr),void 0!==this.textureRgb&&(e.deleteTexture(this.textureRgb),this.textureRgb=void 0),e.deleteProgram(this.convertProgram),e.deleteProgram(this.loadingProgram),e.deleteProgram(this.blitProgram),e.deleteBuffer(this.bufferConvertVertex),e.deleteBuffer(this.bufferBlitVertex),e.deleteBuffer(this.bufferBlitTexCoord),e.deleteFramebuffer(this.fb),this.gl=null,this.canvas=null},e.prototype.resize=function(e,t){if(void 0===this._error){this.width=0|e,this.height=0|t,this.fixWidth=this.width+15>>4<<4,console.info("width:",e),console.info("height:",t);var r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,this.fb),void 0!==this.textureRgb&&(r.deleteTexture(this.textureRgb),this.textureRgb=void 0),this.textureRgb=this.createTexture(3,"textureRgb",this.blitProgram),r.texImage2D(r.TEXTURE_2D,0,r.RGB,this.fixWidth,this.height,0,r.RGB,r.UNSIGNED_BYTE,null),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.textureRgb,0);var s=1,i=1,o=this.width/this.height,a=this.canvas.width/this.canvas.height;0===this.viewMode?o>a?i=this.canvas.width/o/this.canvas.height:s=this.canvas.height*o/this.canvas.width:1===this.viewMode?o>a?s=this.canvas.height*o/this.canvas.width:i=this.canvas.width/o/this.canvas.height:this.viewMode,r.bindBuffer(r.ARRAY_BUFFER,this.bufferBlitVertex);var n=new Float32Array([-1*s,-1*i,s,-1*i,-1*s,i,s,i]);r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null);var l=this.width/this.fixWidth;r.bindBuffer(r.ARRAY_BUFFER,this.bufferBlitTexCoord);var u=new Float32Array([0,0,l,0,0,1,l,1]);r.bufferData(r.ARRAY_BUFFER,u,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null)}},e.prototype.createTexture=function(e,t,r){var s=this.gl,i=s.createTexture();return s.bindTexture(s.TEXTURE_2D,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),i},e.prototype.createProgram=function(e,t){var r=this.gl,s=r.createProgram();return r.attachShader(s,this.compileShader(r.VERTEX_SHADER,e)),r.attachShader(s,this.compileShader(r.FRAGMENT_SHADER,t)),r.linkProgram(s),r.useProgram(s),s},e.prototype.compileShader=function(e,t){var r=this.gl,s=r.createShader(e);if(r.shaderSource(s,t),r.compileShader(s),!r.getShaderParameter(s,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(s));return s},e.prototype.allowsClampedTextureData=function(){var e=this.gl,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,1,1,0,e.LUMINANCE,e.UNSIGNED_BYTE,new Uint8ClampedArray([0])),0===e.getError()},e.prototype.renderProgress=function(e){return},e.prototype.render=function(e,t,r){if(this.enabled&&void 0===this._error){var s=this.gl,i=this.fixWidth,o=this.height,a=i>>1,n=o>>1;s.bindFramebuffer(s.FRAMEBUFFER,this.fb),s.viewport(0,0,this.fixWidth,this.height),s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT),s.useProgram(this.convertProgram),this.shouldCreateUnclampedViews&&(e=new Uint8Array(e.buffer),t=new Uint8Array(t.buffer),r=new Uint8Array(r.buffer)),this.updateTexture(s.TEXTURE0,this.textureY,i,o,e),this.updateTexture(s.TEXTURE1,this.textureCb,a,n,t),this.updateTexture(s.TEXTURE2,this.textureCr,a,n,r),s.uniform1i(this.uniformY,0),s.uniform1i(this.uniformCb,1),s.uniform1i(this.uniformCr,2),s.bindBuffer(s.ARRAY_BUFFER,this.bufferConvertVertex),s.enableVertexAttribArray(this.attrConvertVertex),s.vertexAttribPointer(this.attrConvertVertex,2,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,4),s.bindBuffer(s.ARRAY_BUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,null),s.disableVertexAttribArray(this.attrConvertVertex),s.viewport(0,0,this.canvas.width,this.canvas.height),s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT),s.useProgram(this.blitProgram),s.activeTexture(s.TEXTURE3),s.bindTexture(s.TEXTURE_2D,this.textureRgb),s.uniform1i(this.uniformRgb,3),s.bindBuffer(s.ARRAY_BUFFER,this.bufferBlitVertex),s.enableVertexAttribArray(this.attrBlitVertex),s.vertexAttribPointer(this.attrBlitVertex,2,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.bufferBlitTexCoord),s.enableVertexAttribArray(this.attrBlitTexCoord),s.vertexAttribPointer(this.attrBlitTexCoord,2,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,4),s.bindBuffer(s.ARRAY_BUFFER,null),s.disableVertexAttribArray(this.attrBlitVertex),s.disableVertexAttribArray(this.attrBlitTexCoord)}},e.prototype.updateTexture=function(e,t,r,s,i){var o=this.gl;o.activeTexture(e),o.bindTexture(o.TEXTURE_2D,t),o.texImage2D(o.TEXTURE_2D,0,o.LUMINANCE,r,s,0,o.LUMINANCE,o.UNSIGNED_BYTE,i)},e.prototype.getRenderError=function(){return this._error},e.prototype.enable=function(e){this.enabled=e},e.IsSupported=function(){try{if(!window.WebGLRenderingContext)return!1;var e=document.createElement("canvas");return!(!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return console.info("WebGLRenderer error:",e),!1}},e.SHADER={FRAGMENT_YCRCB_TO_RGBA:["precision mediump float;","uniform sampler2D textureY;","uniform sampler2D textureCb;","uniform sampler2D textureCr;","varying vec2 texCoord;","mat4 rec601 = mat4(","1.16438,  0.00000,  1.59603, -0.87079,","1.16438, -0.39176, -0.81297,  0.52959,","1.16438,  2.01723,  0.00000, -1.08139,","0, 0, 0, 1",");","void main() {","float y = texture2D(textureY, texCoord).r;","float cb = texture2D(textureCb, texCoord).r;","float cr = texture2D(textureCr, texCoord).r;","gl_FragColor = vec4(y, cr, cb, 1.0) * rec601;","}"].join("\n"),FRAGMENT_LOADING:["precision mediump float;","uniform float progress;","varying vec2 texCoord;","void main() {","float c = ceil(progress-(1.0-texCoord.y));","gl_FragColor = vec4(c,c,c,1);","}"].join("\n"),VERTEX_IDENTITY:["attribute vec2 vertex;","varying vec2 texCoord;","void main() {","texCoord = vertex;","gl_Position = vec4((vertex * 2.0 - 1.0) * vec2(1, -1), 0.0, 1.0);","}"].join("\n"),FRAGMENT_BLIT:["precision mediump float;","uniform sampler2D textureRgb;","varying vec2 textureCoordinate;","void main() {","gl_FragColor = texture2D(textureRgb, textureCoordinate);","}"].join("\n"),VERTEX_BLIT:["attribute vec4 vertex;","attribute vec4 texCoord;","varying vec2 textureCoordinate;","void main() {","textureCoordinate = texCoord.xy;","gl_Position = vertex;","}"].join("\n")},e}(),P.Renderer.Canvas2D=function(){var e=function(e){this.canvas=e.canvas||document.createElement("canvas"),this.width=this.canvas.width,this.height=this.canvas.height,this.enabled=!0,Object.defineProperty(this,"error",{get:this.getRenderError});try{this.context=this.canvas.getContext("2d")}catch(e){this._error=e}this.viewMode=e.viewMode||0};return e.prototype.destroy=function(){},e.prototype.resize=function(e,t){this.width=0|e,this.height=0|t;var r=this.width,s=this.height,i=this.width/this.height,o=this.canvas.clientWidth/this.canvas.clientHeight;0===this.viewMode?i<o?r=s*o:s=r/o:1===this.viewMode?i<o?s=r/o:r=s*o:this.viewMode,console.info("imgAR:",i),console.info("viewAR:",o),console.info("viewWidth:",r),console.info("viewHeight:",s),this.canvas.width=r,this.canvas.height=s,this.imageData=this.context.createImageData(this.width,this.height),P.Fill(this.imageData.data,255)},e.prototype.renderProgress=function(e){var t=this.canvas.width,r=this.canvas.height,s=this.context;s.fillStyle="#222",s.fillRect(0,0,t,r),s.fillStyle="#fff",s.fillRect(0,r-r*e,t,r*e)},e.prototype.render=function(e,t,r){this.YCbCrToRGBA(e,t,r,this.imageData.data);var s=0,i=0;0===this.viewMode?(s=(this.canvas.width-this.width)/2,i=(this.canvas.height-this.height)/2,this.context.fillStyle="black",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.putImageData(this.imageData,s,i,0,0,this.width,this.height)):1===this.viewMode?this.context.putImageData(this.imageData,0,0,0,0,this.canvas.width,this.canvas.height):2===this.viewMode&&this.context.putImageData(this.imageData,0,0)},e.prototype.YCbCrToRGBA=function(e,t,r,s){if(this.enabled)for(var i,o,a,n,l,u=this.width+15>>4<<4,h=u>>1,d=0,c=u,g=u+(u-this.width),p=0,f=h-(this.width>>1),m=0,y=4*this.width,b=4*this.width,v=this.width>>1,_=this.height>>1,w=0;w<_;w++){for(var T=0;T<v;T++){i=t[p],o=r[p],p++,a=i+(103*i>>8)-179,n=(88*o>>8)-44+(183*i>>8)-91,l=o+(198*o>>8)-227;var S=e[d++],k=e[d++];s[m]=S+a,s[m+1]=S-n,s[m+2]=S+l,s[m+4]=k+a,s[m+5]=k-n,s[m+6]=k+l,m+=8;var C=e[c++],x=e[c++];s[y]=C+a,s[y+1]=C-n,s[y+2]=C+l,s[y+4]=x+a,s[y+5]=x-n,s[y+6]=x+l,y+=8}d+=g,c+=g,m+=b,y+=b,p+=f}},e.prototype.getRenderError=function(){return this._error},e.prototype.enable=function(e){this.enabled=e},e}(),P.AudioOutput.WebAudio=function(){var e=function(t){this.context=e.CachedContext=e.CachedContext||new(window.AudioContext||window.webkitAudioContext),this.gain=this.context.createGain(),this.destination=this.gain,this.gain.connect(this.context.destination),this.context._connections=(this.context._connections||0)+1,this.startTime=0,this.buffer=null,this.wallclockStartTime=0,this.volume=1,this.enabled=!0,this.unlocked=!e.NeedsUnlocking(),Object.defineProperty(this,"enqueuedTime",{get:this.getEnqueuedTime})};return e.prototype.destroy=function(){this.gain.disconnect(),this.context._connections--,0===this.context._connections&&(this.context.close(),e.CachedContext=null)},e.prototype.play=function(e,t,r){if(this.enabled){if(!this.unlocked){var s=P.Now();return this.wallclockStartTime<s&&(this.wallclockStartTime=s),void(this.wallclockStartTime+=t.length/e)}this.gain.gain.value=this.volume;var i=this.context.createBuffer(2,t.length,e);i.getChannelData(0).set(t),i.getChannelData(1).set(r);var o=this.context.createBufferSource();o.buffer=i,o.connect(this.destination);var a=this.context.currentTime,n=i.duration;this.startTime<a&&(this.startTime=a,this.wallclockStartTime=P.Now()),o.start(this.startTime),this.startTime+=n,this.wallclockStartTime+=n}},e.prototype.stop=function(){this.gain.gain.value=0},e.prototype.getEnqueuedTime=function(){return Math.max(this.wallclockStartTime-P.Now(),0)},e.prototype.resetEnqueuedTime=function(){this.startTime=this.context.currentTime,this.wallclockStartTime=P.Now()},e.prototype.unlock=function(e){if(this.unlocked)e&&e();else{this.unlockCallback=e;var t=this.context.createBuffer(1,1,22050),r=this.context.createBufferSource();r.buffer=t,r.connect(this.destination),r.start(0),setTimeout(this.checkIfUnlocked.bind(this,r,0),0)}},e.prototype.checkIfUnlocked=function(e,t){e.playbackState===e.PLAYING_STATE||e.playbackState===e.FINISHED_STATE?(this.unlocked=!0,this.unlockCallback&&(this.unlockCallback(),this.unlockCallback=null)):t<10&&setTimeout(this.checkIfUnlocked.bind(this,e,t+1),100)},e.NeedsUnlocking=function(){return/iPhone|iPad|iPod/i.test(navigator.userAgent)},e.IsSupported=function(){try{return window.AudioContext||window.webkitAudioContext}catch(e){return!1}},e.CachedContext=null,e}();var A={start:0,playing:1,stop:2};i.prototype.resetPlayer=function(){if(this.player)try{this.player.stop(),this.player.destroy(),this.player=null}catch(e){this.logger.info("zp.rp.0 stop player destroy exception.")}this.state=A.stop,this.stateTimeStamp=Date.now(),this.playerStat={videoBytes:0,videoFrameCnt:0,videoDecodeFrameCnt:0}},i.prototype.newPlayer=function(e){this.resetPlayer();var t,r;if(this.workerPlayerJSBlob)r=this.workerPlayerJSBlob;else if(this.workerUrl)t=this.workerUrl;else{t=function(e){var t=e.split("/"),r=t[t.length-1];return e.replace(r,"")}(document.currentScript.src)+"jsmpeg-stub.min.js"}return this.logger.info("zp.np.0 worker: ",t),this.player=new P.Player(this.urls[this.playUrlIndex%this.urls.length],{audio:!1,canvas:this.view,viewMode:this.viewMode,workerPlayerJS:t,workerPlayerJSBlob:r}),!!this.player&&(this.state=A.start,!0)},i.prototype.setVolume=function(e){if(this.logger.debug("zp.sv.0 call"),"number"!=typeof e||e<0||e>100)return this.logger.info("zp.sv.0 param error"),!1;this.player.volume(e/100),this.logger.debug("zp.sv.0 call success")},i.prototype.getCurrentPlayerUrl=function(){return this.urls[this.playUrlIndex%this.urls.length]},i.prototype.updatePlayerStat=function(){this.playerStat.videoBytes=this.player.playoutStatus.videoBytes,this.playerStat.videoFrameCnt=this.player.playoutStatus.videoFrameCnt,this.playerStat.videoDecodeFrameCnt=this.player.playoutStatus.videoDecodeFrameCnt},i.prototype.enableDecode=function(e){return this.logger.info("zp.ed.0 call"),"boolean"!=typeof e?(this.logger.info("zp.ed.0 param error"),!1):this.player?(this.decode=e,this.player.enableDecode(e),this.logger.info("zp.ed.0 call success "+e),!0):(this.logger.info("zp.ed.0 don't have player"),!1)};var B={start:0,playing:1,stop:2},I={start:0,stop:1,error:2},N={cdn:0,ultra:1};o.prototype.setPlaySourceType=function(e){this.sourceType=e},o.prototype.startPlayingStream=function(e,t,r,s,o,n){this.logger.debug("zpc.sps.0 call");var l=this.playerList[e];if(l||this.stopPlayingStream(e),!(l=this.playerList[e]=new i(this.logger,e,t,r,(this.sourceType,2),s,o,n)))return this.logger.info("zpc.sps.0 new player failed"),!1;++this.playerCount;var u=a(this,l);return this.logger.debug("zpc.sps.0 call result:",u),u},o.prototype.stopPlayingStream=function(e){this.logger.debug("zpc.sps.1.0 call");var t=this.playerList[e];t&&(t.resetPlayer(),P.DestroySingleRenderer(t.view.id),delete this.playerList[e],void 0!==this.playerInfo[e]&&delete this.playerInfo[e],--this.playerCount,this.onPlayStateUpdate(I.stop,t.streamid)),n(this),this.logger.debug("zpc.sps.1.0 call success")},o.prototype.setPlayVolume=function(e,t){var r=this.playerList[e];return r&&r.player?r.player.setVolume(t):(this.logger.info("zpc.spv.0 no player"),!1)},o.prototype.reset=function(){this.logger.debug("zpc.r.0 call");for(var e in this.playerList){var t=this.playerList[e];t&&t.resetPlayer()}this.playerCount=0,this.playerList={},this.playerInfo={},n(this),P.DestroyAllRenderer(),this.logger.debug("zpc.r.0 call success")},o.prototype.enableDecode=function(e,t){this.logger.debug("zpc.ed.0 call"),this.playerInfo[e]=t;var r=this.playerList[e];if(r)if(r.state==B.playing){var s=r.enableDecode(t);this.logger.info("zpc.ed.0 player is playing, streamId="+e+" set decode "+t+s)}else this.logger.info("zpc.ed.0 player is not start palying, streamId= "+e+" set decode "+t);else this.logger.info("zpc.ed.0 cannot find player")},o.prototype.onPlayStateUpdate=function(e,t){},o.prototype.onPlayQualityUpdate=function(e,t){};var F={cdn:0,ultra:1},M={logout:0,trylogin:1,login:2},q={added:0,deleted:1},O={added:12001,deleted:12002,updated:12003},z=5,G=[2e3,2e3,3e3,3e3,4e3],H=3,Y=3e3,V="1.0.3";u.prototype.onPlayStateUpdateHandle=function(e,t){this.onPlayStateUpdate(e,t)},u.prototype.onPlayQualityUpdateHandle=function(e,t){this.onPlayQualityUpdate(e,t)},u.prototype.config=function(e){return this.logger.debug("zc.p.c.0 call"),this.appid=e.appid,this.server=e.server,this.idName=e.idName,this.nickName=e.nickName,this.logger.setLogLevel(e.logLevel),this.workerUrl=e.workerUrl,this.workerPlayerJSBlob=e.workerPlayerJSBlob,void 0!=e.remoteLogLevel?this.logger.setRemoteLogLevel(e.remoteLogLevel):this.logger.setRemoteLogLevel(0),this.logger.setSessionInfo(e.appid,"","",e.idName,""),this.logger.openLogServer(e.logUrl),this.configOK=!0,this.logger.debug("zc.p.c.0 call success"),!0},u.prototype.login=function(e,t,r,s,i){return this.logger.setSessionInfo(this.appid,e,"",this.idName,""),this.logger.info("zc.p.l.0 call:",e,r),this.configOK?(this.runState!==M.logout&&(this.logger.debug("zc.p.l.0 reset"),g(this,M.logout),k(this)),this.logger.debug("zc.p.l.0 begin"),g(this,M.trylogin),this.roomid=e,this.token=r,this.role=t,function(e,t,r){var s=function(){},i=function(){};r.success&&"function"==typeof r.success&&(s=r.success),r.error&&"function"==typeof r.error&&(i=r.error),e.callbackList[t+"SuccessCallback"]=s,e.callbackList[t+"ErrorCallback"]=i}(this,"login",{success:s,error:i}),w(this),T(this),this.logger.info("zc.p.l.0 call success"),!0):(this.logger.info("zc.p.l.0 param error"),!1)},u.prototype.logout=function(){return this.logger.debug("zc.p.l.1.0 call"),this.runState===M.logout?(this.logger.info("zc.p.l.1.0 at logout"),!1):(g(this,M.logout),k(this),this.logger.debug("zc.p.l.1.0 call success"),!0)},u.prototype.setUserStateUpdate=function(e){return this.logger.debug("zc.p.eusu.0 call"),"boolean"!=typeof e?(this.logger.info("zp.p.eusu.0 param error"),!1):(this.userStateUpdate=e,this.logger.debug("zc.p.eusu.0 call success "+e),!0)},u.prototype.sendCustomCommand=function(e,t,r,s){if(this.logger.debug("zc.p.scc.0 call"),this.runState!==M.login)return this.logger.info("zc.p.scc.0 state error"),!1;if(!(e&&e instanceof Array&&0!=e.length))return this.logger.info("zc.p.scc.0 dstMembers error"),!1;var i={dest_id_name:e,custom_msg:t};return m(this,"custommsg",i,r,s),this.logger.debug("zc.p.scc.0 call success"),!0},u.prototype.sendRoomMsg=function(e,t,r,s,i){if(this.logger.debug("srm.0 call"),this.runState===M.login){var o=Date.parse(new Date);if(this.sendRoomMsgTime>0&&this.sendRoomMsgTime+this.SendRoomMsgInterval>o)return this.logger.info("srm.0 freq error"),void(i&&i(W.FREQ_LIMITED,0,e,t,r));this.sendRoomMsgTime=o,this.logger.debug("srm.0 send fetch request");m(this,"im_chat",{msg_category:e,msg_type:t,msg_content:r},s,i),this.logger.debug("srm.0 call success")}else this.logger.info("srm.0 state error")},u.prototype.startPlayingStream=function(e,t,r,s){r=0===r?0:r||1,this.logger.debug("zc.p.sps.0 call");var i="z0";"1"===s&&(i="z1"),this.logger.info("zc.p.sps.0 quality:"+i+" "+s);for(var o=null,a=0;a<this.streamList.length;a++)if(this.streamList[a].stream_id===e){if(this.streamList[a].quality!==i)break;o=this.streamList[a].urls_ws||[],this.streamList[a].viewMode=r;break}if(console.log("streamUrls = ",o),!o||o.length<=0)return this.logger.debug("zc.p.sps.0 fetch stream url"),this.mapViewMode[e]=r,this.mapStreamDom[e]=t,this.mapStreamQuality[e]=i,function(e,t,r){e.logger.debug("fsu.0 call"),e.runState===M.login?(e.logger.debug("fsu.0 send fetch request"),f(e,"stream_url",{stream_ids:[t],quality:r}),e.logger.debug("fsu.0 call success")):e.logger.info("fsu.0 state error")}(this,e,i),!1;this.logger.debug("zc.p.sps.0 play"),h(this,e,t,r)},u.prototype.stopPlayingStream=function(e){return this.logger.debug("zc.p.sps.1.0 call"),e&&""!==e?(this.playerCenter.stopPlayingStream(e),this.logger.debug("zc.p.sps.1.0 call success"),!0):(this.logger.info("zc.p.sps.1.0 param error"),!1)},u.prototype.setPlayVolume=function(e,t){return this.logger.debug("zc.p.spv.0 call"),this.playerCenter.setPlayVolume(e,t),this.logger.debug("zc.p.spv.0 call success"),!0},u.prototype.setPreferPlaySourceType=function(e){return this.logger.debug("zc.p.sppst.0 call"),"number"!=typeof e||e!==F.cdn&&e!==F.ultra?(this.logger.info("zc.p.sppst.0 param error"),!1):(this.preferPlaySourceType=e,this.playerCenter.setPlaySourceType(e),this.logger.debug("zc.p.sppst.0 call success"),!0)},u.prototype.release=function(){this.logger.debug("zc.p.r.0 call"),g(this,M.logout),k(this),this.playerCenter.reset(),this.logger.stopLogServer(),this.logger.debug("zc.p.r.0 call success")},u.prototype.enableDecode=function(e,t){if(this.logger.debug("zc.p.ed.0 call"),this.runState!=M.login)return this.logger.info("zc.p.ed.0 don't login in"),!1;for(var r=!1,s=0;s<this.streamList.length;s++)if(this.streamList[s].stream_id===e){r=!0;break}return r?(this.playerCenter.enableDecode(e,t),this.logger.debug("zc.p.ed.0 call success"),!0):(this.logger.info("zc.p.ed.0 cannot find stream"),!1)};for(var W={SUCCESS:{code:"ZegoClient.Success",msg:"success."},PARAM:{code:"ZegoClient.Error.Param",msg:"input error."},HEARTBEAT_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"heartbeat timeout."},LOGIN_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"login timeout."},SEND_MSG_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"send customsg timeout."},RESET_QUEUE:{code:"ZegoClient.Error.Timeout",msg:"msg waiting ack is clear when reset."},LOGIN_DISCONNECT:{code:"ZegoClient.Error.Network",msg:"network is broken and login fail."},KICK_OUT:{code:"ZegoClient.Error.Kickout",msg:"kickout reason="},UNKNOWN:{code:"ZegoClient.Error.Unknown",msg:"unknown error."},FREQ_LIMITED:{code:"ZegoClient.Error.requencyLimited",msg:"Frequency Limited."}},Q=["onDisconnect","onKickOut","onRecvCustomCommand","onStreamUpdated","onStreamExtraInfoUpdated","onPlayStateUpdate","onRecvRoomMsg","onPlayQualityUpdate","onUserStateUpdate","onGetTotalUserList"],X=0;X<Q.length;X++)u.prototype[Q[X]]=function(){};return u});
